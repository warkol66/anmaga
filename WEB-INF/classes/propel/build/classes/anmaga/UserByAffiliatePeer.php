<?php

  // include base peer class
  require_once 'om/BaseUserByAffiliatePeer.php';
  
  // include object class
  include_once 'UserByAffiliate.php';
  
  include_once 'UsersByAffiliateUserGroupPeer.php';


/**
 * Skeleton subclass for performing query and update operations on the 'users_userbyaffiliate' table.
 *
 * Usuarios de afiliado
 *
 * This class was autogenerated by Propel on:
 *
 * 12/27/06 11:08:05
 *
 * You should add additional methods to this class to meet the
 * application requirements.  This class will only be generated as
 * long as it does not already exist in the output directory.
 *
 * @package mer
 */	
class UserByAffiliatePeer extends BaseUserByAffiliatePeer {

		//Setea si se eliminan realmente los usuarios de la base de datos o se marcan como no activos
		const DELETEUSERS = false;

	  function getUsersByAffiliate($affiliateId) {
		$cond = new Criteria();
		$cond->add(UserByAffiliatePeer::AFFILIATEID,$affiliateId);
		$cond->add(UserByAffiliatePeer::ACTIVE,1);
		$todosObj = UserByAffiliatePeer ::doSelect($cond);
		return $todosObj;
  }


	function getAll() {
		$cond = new Criteria();
		$cond->add(UserByAffiliatePeer::ACTIVE,1);
		$todosObj = UserByAffiliatePeer::doSelect($cond);
		return $todosObj;
  }

  /**
  * Obtiene todos los usuarios desactivados.
	*
	*	@return array Informacion sobre los usuarios
  */
	function getDeleteds() {
		$cond = new Criteria();
		$cond->add(UserByAffiliatePeer::ACTIVE, 0);
		$todosObj = UserByAffiliatePeer::doSelect($cond);
		return $todosObj;
  }

  /**
  * Obtiene todos los usuarios desactivados.
	*
	* @param int $affiliateId Id del afiliado
	*	@return array Informacion sobre los usuarios
  */
	function getDeletedsByAffiliate($affiliateId) {
		$cond = new Criteria();
		$cond->add(UserByAffiliatePeer::AFFILIATEID,$affiliateId);
		$cond->add(UserByAffiliatePeer::ACTIVE, 0);
		$todosObj = UserByAffiliatePeer::doSelect($cond);
		return $todosObj;
  }

	function create($affiliateId,$username,$password,$levelId) {
	
		try{
		$document = new UserByAffiliate();
		$document->setUsername($username);
		$document->setAffiliateId($affiliateId);
		$document->setActive(1);
		$document->setCreated(now);
		$document->setUpdated(now);
		$document->setLevelId($levelId);
		if(!empty($password)){
			$document->setPassword(md5($password."ASD"));
		}
		$document->save();
		}catch (PropelException $e) {}
		return;
	}

  function auth($username,$password) {
		$cond = new Criteria();
		$cond->add(UserByAffiliatePeer::USERNAME, $username);
		$cond->add(UserByAffiliatePeer::ACTIVE, "1");
		$todosObj = UserByAffiliatePeer::doSelect($cond);	
		$user = $todosObj[0];
		if ( !empty($user) ) {
			if ( $user->getPassword() == md5($password."ASD") ) {
				return $user;
			}
		}
		return false;
  }

  function delete($id) {
		$affiliate = UserByAffiliatePeer::retrieveByPk($id);
		if (UserByAffiliatePeer::DELETEUSERS)
			$affiliate->delete();
		else {
			$affiliate->setActive(0);
			$affiliate->save();
		}
		return true;
  }




	function get($id) {
		$obj = UserByAffiliatePeer::retrieveByPK($id);
		return $obj;
	}


  function update($id,$affiliateId,$username,$password,$levelId) {
		$document = UserByAffiliatePeer::retrieveByPK($id);
		$document->setUsername($username);
		$document->setAffiliateId($affiliateId);
		$document->setUpdated(now);
		$document->setLevelId($levelId);
		if(!empty($password)){
			$document->setPassword(md5($password."ASD"));
		}
		$document->save();
		return;
  }
  
  /**
  * Obtiene los grupos de usuarios en los cuales es miembro un usuario.
  *
  * @param int $id Id del usuario
  * @return array Grupos de Usuarios
  */
  function getGroupsByUser($id) {
		$cond = new Criteria();
		$cond->add(UsersByAffiliateUserGroupPeer::USERID, $id);
		$todosObj = UsersByAffiliateUserGroupPeer::doSelectJoinUsersByAffiliateGroup($cond);
		return $todosObj;
  }
  
  /**
  * Agrega un usuario a un grupo de usuarios.
  *
  * @param int $user Id del usuario
  * @param int $group Id del grupo de usuarios
  * @return boolean true si se agrego correctamente, false sino
  */
	function addUserToGroup($user,$group) {
		try {
			$userGroup = new UsersByAffiliateUserGroup();
			$userGroup->setUserId($user);
			$userGroup->setGroupId($group);
			$userGroup->save();
			return true;
		}
		catch (PropelException $e) {
			return false;
		}
	}
	
  /**
  * Elimina un usuario de un grupo de usuarios.
  *
  * @param int $user Id del usuario
  * @param int $group Id del grupo de usuarios
  * @return boolean true si se elimino correctamente, false sino
  */
	function removeUserFromGroup($user,$group) {
		try {
			$cond = new Criteria();
			$cond->add(UsersByAffiliateUserGroupPeer::USERID, $user);
			$cond->add(UsersByAffiliateUserGroupPeer::GROUPID, $group);
			$todosObj = UsersByAffiliateUserGroupPeer::doSelect($cond);
			$obj = $todosObj[0];
			$obj->delete();
			return true;
		}
		catch (PropelException $e) {
			return false;
		}
	}
	
	/**
	* Activa un usuario a partir del id.
	*
  * @param int $id Id del usuario
	*	@return boolean true
	*/
  function activate($id) {
		$user = UserByAffiliatePeer::retrieveByPk($id);
		$user->setActive(1);
		$user->save();
		return true;
  }

} // UserByAffiliatePeer
